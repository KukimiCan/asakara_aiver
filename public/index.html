<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>朝までそれ正解！</title>
  <style>
    body { font-family: sans-serif; background: #fffbe6; padding: 2rem; text-align: center; }
    h1 { font-size: 2rem; margin-bottom: 1rem; }
    button { padding: 0.5rem 1rem; margin: 1rem; font-size: 1rem; cursor: pointer; }
    #prompt { font-size: 1.5rem; margin: 1.5rem 0; }
    ul { list-style: none; padding: 0; }
    li { background: #ffe; margin: 0.5rem auto; padding: 0.5rem; border: 1px solid #ccc; max-width: 400px; }
    #error { color: red; }
  </style>
</head>
<body>
  <h1>朝までそれ正解！</h1>
  <div id="prompt">お題を生成中...</div>
  <button id="nextBtn">次のお題へ</button>
  <button id="revealBtn" disabled>回答を見る</button>
  <ul id="answers"></ul>
  <div id="error"></div>

  <script>
    import questionList from './questions.csv';

    const hiraList = [..."あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわ"];

    let currentAnswers = [];
    let currentIndex = 0;

    async function getAnswers(promptText) {
      try {
        const response = await fetch("/api/gemini", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: `「${promptText}」というお題に対して、ユニークで面白い単語を5つ挙げてください。箇条書きなしで、一行に1単語だけ出力してください。余計な説明は不要です。` })
        });

        const data = await response.json();

        if (!data || !data.candidates || !data.candidates[0]) {
          throw new Error("有効な回答が得られませんでした。");
        }

        return data.candidates[0].content.parts[0].text
          .split(/\n|\r/)
          .map(line => line.replace(/^[-\d\.\s]+/, "").trim())
          .filter(line => line);
      } catch (err) {
        document.getElementById("error").textContent = `エラー: ${err.message}`;
        return [];
      }
    }

    async function showNewQuestion() {
      document.getElementById("error").textContent = "";
      document.getElementById("answers").innerHTML = "";
      document.getElementById("revealBtn").disabled = true;
      currentIndex = 0;
      currentAnswers = [];

      const response = await fetch("/questions.csv");
      const csvText = await response.text();
      const lines = csvText.trim().split("\n");

      const randomQ = lines[Math.floor(Math.random() * lines.length)];
      const randomKana = hiraList[Math.floor(Math.random() * hiraList.length)];
      const promptText = `${randomKana}で始まる${randomQ}`;
      document.getElementById("prompt").textContent = promptText;

      currentAnswers = await getAnswers(promptText);
      document.getElementById("revealBtn").disabled = false;
    }

    function showNextAnswer() {
      if (currentIndex < currentAnswers.length) {
        const li = document.createElement("li");
        li.textContent = currentAnswers[currentIndex++];
        document.getElementById("answers").appendChild(li);
      }
      if (currentIndex >= currentAnswers.length) {
        document.getElementById("revealBtn").disabled = true;
      }
    }

    document.getElementById("nextBtn").addEventListener("click", showNewQuestion);
    document.getElementById("revealBtn").addEventListener("click", showNextAnswer);
    window.addEventListener("load", showNewQuestion);
  </script>
</body>
</html>
